<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY rfc2119 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY rfc3031 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.3031.xml">
<!ENTITY rfc3032 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.3032.xml">
<!ENTITY rfc3985 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.3985.xml">
<!ENTITY rfc4023 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.4023.xml">
<!ENTITY rfc4385 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.4385.xml">
<!ENTITY rfc4446 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.4446.xml">
<!ENTITY rfc4447 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.4447.xml">
<!ENTITY rfc4448 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.4448.xml">
<!ENTITY rfc4553 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.4553.xml">
<!ENTITY rfc4664 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.4664.xml">
<!ENTITY rfc4817 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.4817.xml">
<!ENTITY rfc4875 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.4875.xml">
<!ENTITY rfc5086 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5086.xml">
<!ENTITY rfc5087 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5087.xml">
<!ENTITY rfc5254 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5254.xml">
<!ENTITY rfc5129 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5129.xml">
<!ENTITY rfc5305 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5305.xml">
<!ENTITY rfc5331 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5331.xml">
<!ENTITY rfc5332 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5332.xml">
<!ENTITY rfc5440 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5440.xml">
<!ENTITY rfc5462 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5462.xml">
<!ENTITY rfc5586 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5586.xml">
<!ENTITY rfc5659 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5659.xml">
<!ENTITY rfc5921 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5921.xml">
<!ENTITY rfc5960 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5960.xml">
<!ENTITY rfc6073 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6073.xml">
<!ENTITY rfc6275 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6275.xml">
<!ENTITY rfc6371 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6371.xml">
<!ENTITY rfc6373 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6373.xml">
<!ENTITY rfc6378 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6378.xml">
<!ENTITY rfc6426 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6426.xml">
<!ENTITY rfc6437 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6437.xml">
<!ENTITY rfc6540 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6540.xml">
<!ENTITY rfc6564 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6564.xml">
<!ENTITY rfc6621 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6621.xml">
<!ENTITY rfc6658 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6658.xml">
<!ENTITY rfc6718 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6718.xml">
<!ENTITY rfc6733 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6733.xml">
<!ENTITY rfc6790 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6790.xml">
<!ENTITY rfc7271 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.7271.xml">
<!ENTITY rfc7348 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.7348.xml">
<!ENTITY rfc7426 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.7426.xml">
<!ENTITY rfc7432 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.7432.xml">
<!ENTITY rfc7510 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.7510.xml">

<!ENTITY I-D.ietf-detnet-dp-alt PUBLIC "" "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-detnet-dp-alt.xml">
<!ENTITY I-D.ietf-detnet-problem-statement PUBLIC "" "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-detnet-problem-statement.xml">
<!ENTITY I-D.ietf-detnet-architecture PUBLIC "" "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-detnet-architecture.xml">
<!ENTITY I-D.ietf-mpls-residence-time SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-mpls-residence-time">


]>

<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<?rfc toc="yes"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes"?>
<?rfc iprnotified="no"?>
<?rfc strict="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no"?>
<rfc category="info"
     docName="draft-ietf-detnet-dp-sol-00"
         ipr="trust200902"
         submissionType="IETF">
  <front>
    <title abbrev="DetNet data plane protocol">
     DetNet Data Plane Protocol</title>

  <author role="editor" fullname="Jouni Korhonen" initials="J." surname="Korhonen">
   <organization abbrev="Broadcom">Broadcom</organization>
   <address>
    <postal>
     <street>3151 Zanker Road</street>
     <city>San Jose</city>
     <code>95134</code>
     <region>CA</region>
     <country>USA</country>
    </postal>
    <email>jouni.nospam@gmail.com</email>
   </address>
  </author>

  <author fullname="Loa Andersson" initials="L." surname="Andersson">
   <organization abbrev="Huawei">Huawei</organization>
   <address>
    <email>loa@pi.nu</email>
   </address>
  </author>
  
  <author fullname="Yuanlong Jiang" initials="Y." surname="Jiang">
   <organization abbrev="Huawei">Huawei</organization>
   <address>
    <email>jiangyuanlong@huawei.com</email>
   </address>
  </author>
  
  <author fullname="Bal&aacute;zs Varga" initials="B." surname="Varga">
	<organization>Ericsson</organization>
	<address>
	 <postal>
	  <street>Konyves K&aacute;lm&aacute;n krt. 11/B</street>
	  <city>Budapest</city>
	  <country>Hungary</country>
	  <code>1097</code>
	 </postal>
	 <email>balazs.a.varga@ericsson.com</email>
	</address>
	</author>
 
  <!--author fullname="Donald Fauntleroy Duck" initials="D. F." surname="Duck">
   <organization abbrev="Royal Bros.">Royal Bros.</organization>
   <address>
    <postal>
     <street>13 Paradise Road</street>
     <city>Duckburg</city>
     <region>Calisota</region>
     <country>USA</country>
    </postal>
   </address>
  </author-->
  <date />
  <workgroup>DetNet</workgroup>

  <abstract>
  <t>
   This document specifies a PseudoWire-based Determnistic Networking data
   plane protocol solution. The data plane protocol runs over either IP or MPLS
   Packet Switched Networks.
  </t>
  </abstract>


  </front>

 <middle>
 <section title="Introduction" anchor="sec_intro">
  <t>
   This document specifies a Deterministic Networking (DetNet) data plane
   protocol. The solution is based on PseudoWires (PW) <xref target="RFC3985"/>
   and makes use of the multi-segment (MS-PW) <xref target="RFC6073"/> to map
   DetNet Relays and Edge Nodes <xref
   target="I-D.ietf-detnet-architecture"/><xref
   target="I-D.ietf-detnet-dp-alt"/> to PW architecture. The PW-based data
   plane can be run over either an IP or MPLS <xref target="RFC4448"/><xref
   target="RFC6658"/> Packet Switched Network (PSN).
  </t>
  <t>
   For the purpose of DetNet data plane this document specifically specifies
   the PW encapsulation for DetNet flows, a DetNet Control Word (CW), a DetNet
   label, how MS-PW derived DetNet Relay and Edge nodes work, and as a specific
   new PW feature how the Frame Replication and Elimination for Redundancy
   (FRER) is implemented using PWs. This document does not define the
   associated control plane functions, or operations and management (O&amp;M).
  </t>
 </section>

 <section title="Terminology">
  <t>
   This document uses the terminology established in the DetNet architecture
   <xref target="I-D.ietf-detnet-architecture"/> and the DetNet Data Plane
   Solution Alternatives <xref target="I-D.ietf-detnet-dp-alt"/>.
  </t>
  <t>
   The following terms are also used in this document:
   <list style="hanging" hangIndent="14">
    <t hangText="DA-T-PE">A DetNet aware PseudoWire Terminating Provider Edge (T-PE).
     In the context of this document DA-T-PE is referred as T-PE.</t>
    <t hangText="DA-S-PE">A DetNet aware PseudoWire Switching Provider Edge (S-PE).
     In the context of this document DA-S-PE is referred as S-PE.</t>
    <t hangText="T-Label">A hop-by-hop tunnel label layer between label switch routers (LSR).</t>
    <t hangText="L-Label">A DetNet topology overlay label that is used between DetNet aware
     T-PE or S-PE devices.</t>
    <t hangText="flow-ID">A DetNet flow identity that uniquely identifies a DetNet flow in
     a DetNet domain. The flow-ID is part of the PseudoWire Encapsulation header.</t>
    <t hangText="local-ID">A DA-T-PE and DA-S-PE node internal construct that uniquelly
     identifies a DetNet flow. The local-ID can equal to flow-ID or be derived using other
     means e.g., programming required label to local-ID mappings directly into
     the label information base (LFIB).</t>
	<t hangText="PW Label">A PseudoWire label that is used to identify DetNet
     flow related PW Instances within a PE node.</t> 

   </list>
  </t>
 </section>

 <section title="Requirements language">
  <t>
   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL"
   "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY",
   and "OPTIONAL" in this document are to be interpreted as
   described in <xref target="RFC2119"/>.
  </t>
 </section>

 <section title="DetNet data plane Overview" anchor="sec_dt_dp">
  <t>
   [Ed. to be written.. describe the scope here fot this document: this
   document only addresses the inter-connect case i.e., 802.1 over routed
   network (enlarge the layer-2 domain - EVPAN', and the native DetNet
   case.]
  </t>
  <figure anchor="fig_detnet" align="center"
  title="A simple DetNet enabled network architecture">
  <artwork align="center"><![CDATA[
TSN              Edge          Transit        Relay        DetNet
End System       Node            Node         Node         End System

+---------+    +.........+                                 +---------+
|  Appl.  |<---:Svc Proxy:-- End to End Service ---------->|  Appl.  |
+---------+    +---------+                   +---------+   +---------+
|   TSN   |    |TSN| |Svc|<-- DetNet flow ---: Service :-->| Service |
+---------+    +---+ +---+    +---------+    +---------+   +---------+
|Transport|    |Trp| |Trp|    |Transport|    |Trp| |Trp|   |Transport|
+-------.-+    +-.-+ +-.-+    +--.----.-+    +-.-+ +-.-+   +---.-----+
        :  Link  :    /  ,-----.  \   :  Link  :    /  ,-----.  \
        +........+    +-[  Sub  ]-+   +........+    +-[  Sub  ]-+
                        [Network]                     [Network]
                         `-----'                       `-----'
]]></artwork>
</figure>


  <t>
   <xref target="fig_8021_detnet"/> illustrates how DetNet can provide services
   for IEEE 802.1TSN end systems over a DetNet enabled network.  The edge nodes
   insert and remove required DetNet data plane encapsulation.  The 'X' in
   the edge and relay nodes represents a potential DetNet flow packet
   replication and elimination point.  This conceptually parallels L2VPN
   services, and could leverage existing related solutions as discussed
   below.
  </t>

  <figure align="center" anchor="fig_8021_detnet"
  title="IEEE 802.1TSN over DetNet">
  <artwork><![CDATA[
       TSN    |<----- End to End DetNet Service ----->|  TSN
      Service |        Transit          Transit       | Service
TSN    (AC)   |     |<-Tunnel->|     |<-Tunnel->|     |  (AC)     TSN
End     |     V     V     1    V     V     2    V     V   |       End
System  |     +-----+          +-----+          +---- +   |    System
+---+   |     |T-PE1|==========|S-PE1|==========|T-PE2|   |    +---+
|   |---|-----|.X_..DetNet Flow1._ _.|...DF3........X.|---|----|   |
|CE1|   |     |  \  |          |  X  |          |  /  |   |    |CE2|
|   |         |   \_...DF2......./ \.|...DF4....../   |        |   |
+---+         |     |==========|     |==========|     |        +---+
    ^         +-----+          +-----+          +-----+        ^
    |        Edge Node        Relay Node       Edge Node       |
    |                                                          |
    |<--------------- Emulated TSN Service ------------------->|
]]>
</artwork>
</figure>

 <t>
  <xref target="fig_native_detnet"/> illustrates how end to end DetNet service
  can be provided. In this case, the end systems are able to send and receive
  DetNet flows.  For example, put application data in PseudoWire (PW) and
  encapsulated in IP.  Like earlier the 'X' in the end systems, edge and relay
  nodes represents potential DetNet flow packet replication and elimination
  points. Here the relay nodes may change the underlying transport, for example
  replacing IP with MPLS or tunneling IP over MPLS, or simply interconnect
  network domains.
 </t>

<figure align="center" anchor="fig_native_detnet"
 title="Native DetNet">
<artwork><![CDATA[
       DetNet                                           DetNet
       Service         Transit          Transit        Service
DetNet   |          |<-Tunnel->|     |<-Tunnel->|         |    DetNet
End      |          V     1    V     V     2    V         |    End
System   |    +-----+          +-----+          +-----+   |    System
+---+    |    |S-PE1|==========|S-PE2|==========|S-PE3|   |    +---+
|  X....DFa.....X_.......DF1....._ _.....DF3........X.....DFa...X  |
|CE1|=========|  \  |          |  X  |          |  /  |========|CE2|
|   |    |    |   \......DF2...../ \.....DF4....../   |   |    |   |
+---+         |     |==========|     |==========|     |        +---+
    ^         +-----+          +-----+          +-----+        ^
    |        Relay Node       Relay Node       Relay Node      |
    |                                                          |
    |<------------- End to End DetNet Service ---------------->|
]]></artwork>
</figure>

<section title="DetNet data plane solution requirements">
 <t>
 Two major groups of scenarios can be distinguished which require flow
 identification during transport:
 </t>

 <t><list style="numbers">
  <t>DetNet function related scenarios:
  <list style="symbols">
   <t>Congestion protection: usage of allocated resources (queuing, policing, shaping).</t>
   <t>Explicit routes: select/apply the flow specific path.</t>
   <t>Service protection: recognize compound / member flows for replication an elimination.</t>
  </list>
 </t>
 <t>OAM function related scenarios:
  <list style="symbols">
   <t>troubleshooting (e.g., identify misbehaving flows, etc.)</t>
   <t>recognize flow(s) for analytics (e.g, increase counters, etc.)</t>
   <t>correlate events with flows (e.g., volume above threshold, etc.)</t>
   <t>etc.</t>
  </list>
 </t>
 </list></t>
 <t>
  Each node (DA-T-PE, DA-S-PE and P) use a local-ID of the DetNet-(compound)-flow in
  order to accomplish its role during transport. Recognizing the flow-ID is more
  relaxed for DA-T-PE and DA-S-PE nodes, as they are fully aware of both the DetNet
  service and transport layers. The DetNet role of intermediate "P" nodes is
  limited to ensure congestion protection from the above listed DetNet
  functions. However P nodes can usually recognize only "T-label" and cannot
  consider the whole label stack for flow recognition. Therefore identifing each
  individual DetNet flow on a P node may not be achieved in some network
  scenarios.
 </t>

 <t>
  On each node dealing with DetNet flows a local-ID is assumed to determine what
  local operation a packet goes through. Therefore local-IDs MUST be unique on
  each DA-T-PE and DA-S-PE nodes. Local-ID MUST be unambiguously bound to the
  Flow-ID encoded in the DetNet packet. 
 </t>
  
 <!--t>
 DP solution MUST ensure that:
  <list style="symbols">
   <t>DA-*-PE nodes are able to distinguish individual PWs going through and PWs
    need DetNet specific operation (e.g., FRER)</t>
   <t>DA-*-PE nodes do not have PW-label value collisions or can deal with it
    without major implementation difficulties</t>
   <t>it is easy to distinguishing replica flows (required for OAM purposes)</t>
   <t> label allocation works with both centralized control and distributed control
    (signaling)</t>
  </list>
 </t-->
 </section>
</section>

<!-- ================================================================= -->

<section title="DetNet data plane solution">
 <section title="DetNet Control Word">
  <t>
   The DetNet control word (d-CW) is identical to the control word defined for
   Ethernet over MPLS networks in <xref target="RFC4448"/>. The DetNet control
   word is illustrated in <xref target="fig_detnet_cw"/>.
  </t>
    <figure title="DetNet Control Word" anchor="fig_detnet_cw">
    <artwork align="center"><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|0 0 0 0|  reserved - set to 0  |   16 bit Sequence Number      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]>
    </artwork></figure>
 </section>

 <section title="DetNet flow identity word">
  <t>
   The DetNet flow identity word (flow-ID) identifies a DetNet flow uniquely within
   a DetNet domain. The flow-ID is also associated with the sequence number
   carried in the DetNet control word and used also for FRER purposes.
  </t>
    <figure title="DetNet flow identity word" anchor="fig_detnet_fi">
    <artwork align="center"><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   reserved    |               24 bit flow identity            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]>
    </artwork></figure>
  <t>
   The management and assignment of the flow-IDs is outside of this specification.
   It is assumed that each DA-T-PE node have either a preconfigured flow-ID
   number space or some dynamic control plane protocol is able to coordinate
   the allocation of the flow-IDs across the DA-T-PE nodes.
  </t>
  <t>
   The reserved field in the flow-ID MUST be set to zero and ignored when received.
  </t>
 </section>

 <section title="DetNet encapsulation">
  <t>
   The DetNet data plane follows PW encapsulation. This document specifies a
   single encapsulation that can be used over both MPLS and IP packet switched
   Networks (PSN). The DetNet data plane encapsulation consists of a
   <list style="symbols">
    <t>DetNet control word (d-CW): contains sequencing information for
     frame replication and duplicate elimination purposes. There is a separate
     sequence number space per each DetNet label.</t>
    <t>DetNet flow-ID (f-ID): uniquelly identifies a DetNet flow within a DetNet
     domain. Multiple DetNet PWs with different PW labels may have the same 
     f-ID, which then implies the PWs are actually subflows of one compound
     flow.</t> 
    <t>PseudoWire Label (PW Label;): a standard PW label that identifies a PW Instance
     within a (DA-)T-PE or (DA-)S-PE device.</t>
    <t>DetNet topology overlay label (L-label): an optional label used  between
     (DA-)T-PE or (DA-)S-PE nodes. The chief use for L-labels is to tunnel PWs
     through a PE node and therefore effectively making a PE node to behave like
     a P node.</t>
   </list>
   In a case of MPLS-based PSN, the tunnel labels between LSRs are referred as
   T-labels.
  </t>
  <t>
   The DetNet CW and the Detnet flow-ID together constitute the DetNet PseudoWire
   encapsulation header. 
   <list>
    <t>
     [Editor's note: The current design has the DetNet flow-id as part of the
     every DetNet flow packet. The flow-id identifies the flow uniquelly within
     the DetNet domain and together with the sequence number information from the
     DetNet control word is used for FRER purposes. The flow-id makes is easy for
     the DA-*-PE node to associate different PWs into one compound flow and
     perform the elimination of duplicate packets. The flow-id would point at the
     node internal construct that holds the received packet history for each
     DetNet flow of interest. However, it could also be possible
     to associate multiple PWs into one DetNet flow just using the control plane
     provided information. In this case different PWs (using any PW label) would
     be mapped internally within a node to a local-ID, which again points at the
     intenal per DetNet flow received packets history construct. The explicit
     in-band flow-id is easy from the processing and control plane  point of view.
     The local-ID approach does not need the in-band information (thus has less
     overhead) but requires more from the control plane and the mapping information
     has to be stored into the LFIB. Current design decision is the
     in-band flow-id but may be changed to local-ID if there is a strong reason
     to do the change.]
    </t>
   </list></t>
  
  <t>
   <xref target="fig_pw_mpls"/> illustrates a DetNet PseudoWire encapsulation
   using an MPLS PSN. Similarly <xref target="fig_pw_ip"/> illustrates the
   DetNet PseudoWire encaosulation when IP PSN is used. The encapsulation is
   uniform above the PSN.
  </t>
  <t>
   Depending on the network topology the "overlay label" may be part of the
   label stack. This "L-label" has actually nothing specific to do with DetNet
   but can be used to build overlay topologies over the provider network in a
   same way virtual private networks (VPN) are built.
  </t>

  
  <!--section title="Encasulation for MPLS PSN"-->

    <figure title="Encapsulation of DetNet flow in a PW with MPLS(-TP) PSN" anchor="fig_pw_mpls">
    <artwork align="center"><![CDATA[
+-------------------------------+
|                               |
|          DetNet Flow          |
|        Payload  Packet        |  n octets
|                               |
/===============================\           --+
H      DetNet flow identity     H  4 octets   |
H-------------------------------H             +-> PW encapsulation
H      DetNet Control Word      H  4 octets   |
\===============================/           --+
|          PW Label             |  4 octets --> PW demultiplexer
+-------------------------------+
| DetNet topology overlay Label |  4 octets (optinal)
+-------------------------------+
|   Server MPLS Tunnel Label(s) |  n*4 octets 
+-------------------------------+
]]>
    </artwork></figure>
   <!--/section-->

   <t>
   <!--VB needs update to clarify meaning -->
    When IP PSN is used the label stack it transport are only inspacted when the
    IP packet reaches its destination. 
   </t>


   <!--section title="Encapsulation for IP PSN"-->
    <figure title="Encapsulation of DetNet flow in a PW with IP PSN" anchor="fig_pw_ip">
    <artwork align="center"><![CDATA[
+-------------------------------+
|                               |
|          DetNet Flow          |
|        Payload  Packet        |  n octets
|                               |
/===============================\           --+
H      DetNet flow identity     H  4 octets   |
H-------------------------------H             +-> PW encapsulation
H      DetNet Control Word      H  4 octets   |
\===============================/           --+
|          PW Label             |  4 octets --> PW demultiplexer
+-------------------------------+
| DetNet topology overlay Label |  4 octets (optional)
+-------------------------------+
|      Optional UDP Header      |  0 or 8 octets
+-------------------------------+
|      IPv4 or IPv6 Header      |  20 or 40 (or more octets
+-------------------------------+  with extension headers)
]]>
    </artwork></figure>
  <!--/section-->
  </section>
 </section>

  <section title="PE reference model considerations">
   <section title="Forwarded clarifications">
    <t>
     [Ed. The Detnet-aware "extended forwarder" does the heavy lifting on maintaining
     the sequence numbers associated with the DetNet labels. Extended forwarder is also
     responsible for frame replication and duplicate elimination. See the excerpt from
     RFC3985 Section 4.2.1. about forwarder's functions. We extend that to FRER:
     <list style="none">
     <t>
       Some applications have to forward payload elements selectively from
       one or more ACs to one or more PWs.  In such cases, there will also be
       a need to perform the inverse function on PWE3-PDUs received by a PE
       from the PSN.  This is the function of the forwarder.
     </t></list>
     ]
    </t>
   </section>

   <section title="DA-T-PE processing clarifications" anchor="sec_t_pe">
    <t>
     The PW-based DetNet data plane solution overloads the T-PE with a DetNet
     Edge Node function. Such T-PE is referred as DA-T-PE and implies the
     T-PE is also aware of DetNet flows and may need to operate upon those.
     <xref target="fig_detnet_edge"/> illustrates the overall DA-T-PE device
     functions. The figure shows both physical attachment circuit (AC) (e.g.,
     Ethernet <xref target="RFC4448"/>) connecting to the PE, and a packet
     service connecting to the PE via an embedded label switch router (LSR)
     function <xref target="RFC6658"/>.
    </t>

    <figure title="DetNet Edge Node as a T-PE" anchor="fig_detnet_edge">
    <artwork align="center"><![CDATA[
            +---------------------------------------+
            |             DA-T-PE Device            |
            +---------------------------------------+   Egress/
            |             | Forwarder |             |   Ingress
            |  LSR        |           |    Single   | PW Instance
Client PSN  |  ("Packet   X <-*-----> X PW Instance X<---------->
LSPs        |    NSP")    |   | Repl. |             |
<---------->X             |   | Elim. +-------------+ Duplicate
            |             |   :       |             |   Egress
            |             |   .       |    Single   | PW Instance
            |             |       +-> X PW Instance X<---------->
            |             |       |   |             |
            +-------------+       |   +-------------+   Egress/
            |             |       |   |             |   Ingress
Client AC   |    NSP      | Repl. |   |    Single   | PW Instance
<---------->X             X <-----*-> X PW Instance X<---------->
            |             | Elim.     |             |
            +-------------+           +-------------+   Egress/
            |             |           |             |   Ingress
Client AC   |    NSP      |           |    Single   | PW Instance
<---------->X             X <-------> X PW Instance X<---------->
            |             |           |             |
            +---------------------------------------+


			UPDATED FIGURE BELOW
			
            +---------------------------------------+
            |             DA-T-PE Device            |
            +---------------------------------------+   Egress/
            |             | Forwarder |             |   Ingress
            |  LSR        |           |    Single   | PW Instance
Client PSN  |  ("Packet   o <-X-----> o PW Instance o<---------->
LSPs        |    NSP")    |   | Repl. |             |
<---------->o             |   | Elim. +-------------+ Duplicate
            |             |   :       |             |   Egress
            |             |   .       |    Single   | PW Instance
            |             |       +-> o PW Instance o<---------->
            |             |       |   |             |
            +-------------+       |   +-------------+   Egress/
            |             |       |   |             |   Ingress
Client AC   |    NSP      | Repl. |   |    Single   | PW Instance
<---------->o             o <-----X-> o PW Instance o<---------->
            |             | Elim.     |             |
            +-------------+           +-------------+   Egress/
            |             |           |             |   Ingress
Client AC   |    NSP      |           |    Single   | PW Instance
<---------->o             o <-------> o PW Instance o<---------->
            |             |           |             |
            +---------------------------------------+
]]>
    </artwork></figure>

<!--VB Denote with X the FRER function to be consistent   -->

	
	
    <t>
     A DA-T-PE participates to the frame replication and duplication
     elimination. Required processing is done within an extended forwarder
     function. In the case the native service processing (NSP) is IEEE 802.1CB
     <xref target="IEEE8021CB"/> capable the frame replication and duplicate
     elimination MAY entirely be done in the NSP and bypassing the DetNet PW
     encapsulation and logic entirely.
    </t>
    <t>
     The DetNet-aware extended forwarder selects the egress segment PW based on
     the rules described in <xref target="RFC4448"/> and <xref
     target="RFC6658"/>.  In both "normal AC" and "Packet AC" cases there is no
     DetNet encapsulation header available yet as it is the case with DA-S-PEs
     (see <xref target="sec_s_pe"/>).  It is the responsibility of the extended
     forwarder within the DA-T-PE to push the DetNet encapsulation header (i.e.,
     the DetNet CW and the DetNet flow-ID) to the packet before forwarding it to
     the appropriate egress PW instance(s). The extended forwarder MAY copy the
     sequencing information from the native packet into the DetNet CW and vice
     versa. If there is no existing sequencing information available in the
     native packet or the forwarded chose not to copy it from the native packet,
     then the extended forwarded MUST maintain a sequence number counter for
     each DetNet flow (indexed by the flow-ID).
    </t>
   </section>


   <section title="DA-S-PE processing clarifications" anchor="sec_s_pe">
    <t>
     The PW-based DetNet data plane solution overloads a S-PE with a DetNet
     Relay function. Such S-PE device is referred as DA-S-PE and implies the
     S-PE is also aware of DetNet flows and may operate upon those. <xref
     target="fig_detnet_relay"/> illustrates the overall DA-S-PE device
     functions.
    </t>
    <t>
     A DA-S-PE participates to the frame replication and duplication
     elimination. This processing is done within an extended forwarder function.
    </t>
    <t>
     The DetNet-aware forwarder selects the egress segment PW based on the PW
     label.  The mapping of ingress PW label to egress PW label may be
     statically or dynamically configured. Additionally the DetNet-aware
     forwarder does duplicate frame elimination based on the DetNet flow-ID and
     DetNet Control Word sequence number combination. The frame replication is
     also done within the DetNet-aware forwarder. During elimination and the
     replication process both DetNet CW sequence number and DetNet flow-ID MUST
     be preserved and copied to the egress PW.
     [to be completed..]
    </t>

    <figure title="DetNet Relay Node as a S-PE" anchor="fig_detnet_relay">
    <artwork align="center"><![CDATA[
            +---------------------------------------+
            |             DA-S-PE Device            |
            +---------------------------------------+
  Ingress   |             | Forwarder |             |   Egress
PW instance |   Single    |           |    Single   | PW Instance
----------->X PW Instance X --*-----> X PW Instance X----------->
            |             |   | Elim. |             |
            +-------------+   |       +-------------+ Duplicate
  Ingress   |             |   |       |             |   Egress
PW instance |   Single    |   |       |    Single   | PW Instance
----------->X PW Instance X --+   +-> X PW Instance X----------->
            |             |       |   |             |
            +-------------+       |   +-------------+
  Ingress   |             |       |   |             |   Egress
PW instance |   Single    | Repl. |   |    Single   | PW Instance
----------->X PW Instance X ------*-> X PW Instance X----------->
            |             |           |             |
            +-------------+           +-------------+
  Ingress   |             |           |             |   Egress
PW instance |   Single    |           |    Single   | PW Instance
----------->X PW Instance X --------> X PW Instance X----------->
            |             |           |             |
            +---------------------------------------+

			UPDATED FIGURE BELOW
			
            +---------------------------------------+
            |             DA-S-PE Device            |
            +---------------------------------------+
  Ingress   |             | Forwarder |             |   Egress
PW instance |   Single    |           |    Single   | PW Instance
----------->o PW Instance o --X-----> o PW Instance o----------->
            |             |   | Elim. |             |
            +-------------+   |       +-------------+ Duplicate
  Ingress   |             |   |       |             |   Egress
PW instance |   Single    |   |       |    Single   | PW Instance
----------->o PW Instance o --+   +-> o PW Instance o----------->
            |             |       |   |             |
            +-------------+       |   +-------------+
  Ingress   |             |       |   |             |   Egress
PW instance |   Single    | Repl. |   |    Single   | PW Instance
----------->o PW Instance o ------X-> o PW Instance o----------->
            |             |           |             |
            +-------------+           +-------------+
  Ingress   |             |           |             |   Egress
PW instance |   Single    |           |    Single   | PW Instance
----------->o PW Instance o --------> o PW Instance o----------->
            |             |           |             |
            +---------------------------------------+
]]>
    </artwork></figure>

<!--VB Denote with X the FRER function to be consistent      -->


  </section>

  <section title="Frame replication and elimination considerations">
   <t>
    [Editor's note: Describe the elimination and replication procedure here in more
     detail. This is going to take place in PW instance and consists of
     two step operation: 1) eliminate and 2) replicate if necessary.]
   </t>
   <t>
    [Editor's note: draw here an example of LFIB with the elimination
     action.]
   </t>

  </section>
</section>

<section title="Other DetNet considerations">
 <section title="Class of Service">
  <t>
   [Ed. Discuss the CoS.. and how that is archieved when using MPLS or IP PSN.]
  </t>
 </section>

 <section title="Quality of Service">
  <t>
   [Ed. Elaborate the QoS issues here..]
  </t>
 </section>

 <section title="Time-synchronization">
  <t>
   [Ed. discribe a bit of issues and deployment considerations related to
   time-synchronization within DetNet. Refer to DT discussion and the slides
   that summarize different approaches and rough synchronization performance
   numbers.  Finally, scope time-synchronization solution outside data plane.]
  </t>
 </section>
 
 <section title="Bidirectional traffic">
  <t>
   Some DetNet applications generate bidirectional traffic and may require symmetric
   flows. There are already mechanisms that can be used to create bidirectional
   tunnels at the transport network level, such as MPLS-TP. The data plane solution
   SHOULD allow establishing bidirectional symmetric flows. Control plane mechanisms
   would need to also support this, though this is out of scope of this document.
   [Summary of existing mechanisms to create bidirectional tunnels that can be used.]
  </t>
 </section>

</section>

<!-- ===================================================================== -->

<section title="Control plane considerations">
 <t>
  [Editor's note: discuss here what kind of enhancements are needed for DetNet
   and specifically for FRER.]
 </t>
 
 <section title="PW Label assignment and distribution">
  <t>
   The PW label distribution follows the same mechanisms specified for
   MS-PW <xref target="RFC6073"/>.
  </t>
 </section>

</section>


<!-- ===================================================================== -->


<section title="Security considerations">
  <t>
   This document probably has security considerations.
  </t>
</section>


<section anchor="iana" title="IANA Considerations">
  <t>TBD.
  </t>
</section>

<section anchor="acks" title="Acknowledgements">
  <t>The author(s) ACK and NACK.
  </t>
  <t> The following people were part of the DetNet Data Plane Protocol Design Team:
  <list style="bullets">
   <t>Jouni Korhonen</t>
   <t>J&aacute;nos Farkas</t>
   <t>Norman Finn</t>
   <t>Bal&aacute;zs Varga</t>
   <t>Loa Andersson</t>
   <t>Tal Mizrahi</t>
   <t>David Mozes</t>
   <t>Yuanlong Jiang</t>
   <t>Carlos J. Bernardos</t>
  </list></t>
  <t>
   The DetNet chairs serving during the DetNet Data Plane Protocol Design Team:
   <list style="bullets">
    <t>Lou Berger</t>
    <t>Pat Thaler</t>
   </list></t>
</section>
</middle>

<back>
  <references title="Normative References">
   &rfc3985;
   &rfc3031;
   &rfc6073;
   &rfc4448;
   &rfc6658;
   &rfc4023;
   &rfc7510;
   &rfc2119;
  </references>
  <references title="Informative References">
   &rfc3032;
   &rfc4385;
   &rfc5921;
   &I-D.ietf-detnet-dp-alt;
   &I-D.ietf-detnet-architecture;
   &I-D.ietf-detnet-problem-statement;
   &I-D.ietf-mpls-residence-time;
   <reference anchor="IEEE8021CB"
     target="http://www.ieee802.org/1/files/private/cb-drafts/d2/802-1CB-d2-1.pdf">
    <front>
     <title>Draft Standard for Local and metropolitan area networks - Seamless Redundancy</title>
     <author initials="N. F." surname="Finn" fullname="Norman Finn">
      <organization>IEEE 802.1</organization>
     </author>
     <date month="December" year="2015"/>
    </front>
    <seriesInfo name="IEEE P802.1CB /D2.1" value="P802.1CB"/>
    <format type="PDF" target="http://www.ieee802.org/1/files/private/cb-drafts/d2/802-1CB-d2-1.pdf"/>
   </reference>

  </references>
 <section title="Example of DetNet data plane operation" anchor="sec_comb">
  <t>
   [Ed. Simplified example of DetNet data plane and how labels etc work in a case of
    MPLS-based PSN and utilizing FRER. The figure is out of date and pending DT
    decisions on the label handling..]
  </t>
    <figure title="Replication and elimination example" anchor="fig_detnet_ex1">
    <artwork align="center"><![CDATA[
                +-----S-PE1-----------S-PE2-----+                 
               /        |             / |        \      
              /         |            /  |         \    
             /          |           /   |          \  
E1 <------T-PE1         |          /    |         T-PE2------> E3
             \          |         /     |          /  
              \         |  +-----+      |         /    
               \        | /             |        /      
               R1-----S-PE3-----------S-PE4-----R2               
               /        | \             |        \      
              /         |  \            |         \    
             /          |   \           |          \  
E2 <------T-PE3         |    \          |         T-PE4------> E4
             \          |     \         |          /  
              \         |      +-----+  |         /    
               \        |             \ |        /      
                +-----S-PE5-----------S-PE6-----+                
]]>
</artwork></figure>

    <figure title="LFIB contents" anchor="fig_lfib2">
    <artwork align="center"><![CDATA[
+========+================+===============+================================+
|        |                |  Elimination  |     Forwarding Semantics       |
| Device | Incoming-Label |---------------|--------------------------------|
|        |                |   local-ID    | Outgoing-Label | Outgoing-Link |
+========+================+===============+================+===============+
| T-PE1  | N/A (from AC)  |               |                |               |
|        |                |               |                |               |
+========+================+===============+================+===============+
| T-PE2  |                |               |                |               |
|        |                |               |                |               |
+========+================+===============+================+===============+
| T-PE3  | N/A (from AC)  |               |                |               |
|        |                |               |                |               |
+========+================+===============+================+===============+
| T-PE4  |                |               |                |               |
|        |                |               |                |               |
+========+================+===============+================+===============+
| S-PE1  |                |               |                |               |
+========+================+===============+================+===============+
| S-PE2  |                |               |                |               |
+========+================+===============+================+===============+
| S-PE3  |                |               |                |               |
+========+================+===============+================+===============+
| S-PE4  |                |               |                |               |
+========+================+===============+================+===============+
| S-PE5  |                |               |                |               |
+========+================+===============+================+===============+
| S-PE6  |                |               |                |               |
+========+================+===============+================+===============+
| R1     |                |     N/A       |                |               |
+========+================+===============+================+===============+
| R2     |                |     N/A       |                |               |
+========+================+===============+================+===============+
]]></artwork></figure>

 </section>

 <section title="Example of pinned paths using IP PSN">
 </section>

 </back>
</rfc>
